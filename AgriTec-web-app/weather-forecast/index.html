<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Monitor/title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f3f8f5;
      --card:#ffffff;
      --accent:#2c5f2d;
      --muted:#6b7280;
      --glass: rgba(255,255,255,0.8);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:linear-gradient(180deg,#e9f6ef 0%,var(--bg) 100%);color:#042;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:100%;max-width:1100px;background:var(--glass);box-shadow:0 10px 30px rgba(2,6,23,0.08);border-radius:14px;overflow:hidden;display:grid;grid-template-columns:1fr 420px;gap:18px;padding:18px;}
    @media (max-width:980px){.wrap{grid-template-columns:1fr;}}
    /* Left: main UI */
    .panel{padding:18px;background:var(--card);border-radius:10px;min-height:420px;}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:14px;}
    input[type="text"]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #e6e9ea;font-size:15px;}
    button{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;color:var(--accent);border:1px solid #d6e9d9}
    .mic{width:44px;height:44px;border-radius:10px;display:inline-grid;place-items:center;background:#ffecec;color:#b00020;font-weight:700;border:1px solid rgba(0,0,0,0.06)}
    .current{display:flex;align-items:center;gap:14px;margin-bottom:10px}
    .current img{width:96px;height:96px;border-radius:10px;object-fit:cover}
    .cw{flex:1}
    .cw h2{margin:0;font-size:20px;color:var(--accent)}
    .cw p{margin:6px 0;color:var(--muted)}
    .metrics{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .metric{background:#f7fffa;padding:8px;border-radius:8px;border:1px solid rgba(44,95,45,0.06);min-width:110px}
    /* chart container */
    .chart-wrap{background:transparent;padding:10px;border-radius:8px}
    /* Right: chat boat */
    .side{padding:18px;background:linear-gradient(180deg,#fbfff9,#f1faf4);border-radius:10px;min-height:420px;display:flex;flex-direction:column;gap:10px}
    .chat-window{flex:1;overflow:auto;padding:8px;border-radius:8px;border:1px dashed rgba(0,0,0,0.05);background:#fff}
    .msg{margin:8px 0;display:flex;gap:8px}
    .msg.me{justify-content:flex-end}
    .bubble{max-width:80%;padding:8px 12px;border-radius:12px;background:#eef7ee;border:1px solid rgba(44,95,45,0.06)}
    .bubble.me{background:#2c5f2d;color:white}
    .chat-controls{display:flex;gap:8px;align-items:center}
    small.note{color:var(--muted);display:block;margin-top:6px}
    footer.credits{grid-column:1/-1;text-align:center;padding:8px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>

  <div class="wrap" role="application" aria-label="Weather monitor with voice and chat boat">

    <!-- LEFT -->
    <div class="panel" id="mainPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 style="margin:0;color:var(--accent)">Weather Monitor</h3>
        <div style="font-size:13px;color:var(--muted)">Live â€¢ Voice â€¢ Chart</div>
      </div>

      <div class="controls" aria-hidden="false">
        <input id="cityInput" type="text" placeholder="Enter city (or say it) â€” e.g., Bengaluru" />
        <button id="searchBtn">Search</button>
        <button id="micBtn" class="mic" title="Speak city">ðŸŽ¤</button>
      </div>

      <div id="status" class="note" style="color:var(--muted);font-size:13px;margin-bottom:8px">No data loaded yet.</div>

      <!-- Current weather -->
      <div class="current" id="currentCard" aria-live="polite" style="display:none">
        <img id="icon" src="" alt="weather icon" />
        <div class="cw">
          <h2 id="place">â€”</h2>
          <p id="desc">â€”</p>

          <div class="metrics" id="metrics">
            <!-- metric boxes -->
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:28px;font-weight:700" id="temp">--Â°C</div>
          <div style="color:var(--muted);font-size:13px" id="feels">Feels like --Â°C</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-wrap" style="margin-top:10px;background:#fff;padding:12px;border-radius:10px">
        <canvas id="tempChart" height="160"></canvas>
      </div>

      <small class="note">Tip: Click the mic and say "Bengaluru" or "Show weather for Mumbai".</small>
    </div>

    <!-- RIGHT: Chat boat -->
    <aside class="side" id="sidePanel" aria-label="Chat boat">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Chat Boat</strong>
        <small style="color:var(--muted)">Voice replies available</small>
      </div>

      <div class="chat-window" id="chatWindow" role="log" aria-live="polite">
        <div class="msg"><div class="bubble">Hello! Ask me about weather or say "current city".</div></div>
      </div>

      <div class="chat-controls">
        <input id="chatInput" placeholder="Ask: e.g., What's the humidity? or 'forecast for Delhi'" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6efe6" />
        <button id="sendChat" class="secondary">Send</button>
        <button id="voiceChat" class="mic" title="Voice chat">ðŸ”Š</button>
      </div>

      <small class="note">Examples: "What's the temperature?", "forecast for Pune", "help"</small>
    </aside>

    <footer class="credits">Built by Team AgriTech Vision<code>82bee4d9e614d5d786af1b2372f9064b</code> before use.</footer>
  </div>

<script>
/* =========================
  Replace with your API key
  Get one at https://openweathermap.org/api
   - We'll use the 3-hour / forecast endpoint or OneCall for hourly if available.
   - This demo uses OpenWeatherMap's "onecall" via lat/lon (requires separate geocoding call).
========================= */
const OWM_API_KEY = 'YOUR_API_KEY'; // <-- REPLACE THIS

/* -------------------------
   Helper: DOM refs
------------------------- */
const cityInput = document.getElementById('cityInput');
const searchBtn = document.getElementById('searchBtn');
const micBtn = document.getElementById('micBtn');
const statusEl = document.getElementById('status');
const currentCard = document.getElementById('currentCard');
const placeEl = document.getElementById('place');
const descEl = document.getElementById('desc');
const tempEl = document.getElementById('temp');
const feelsEl = document.getElementById('feels');
const iconEl = document.getElementById('icon');
const metricsEl = document.getElementById('metrics');
const chatWindow = document.getElementById('chatWindow');
const chatInput = document.getElementById('chatInput');
const sendChat = document.getElementById('sendChat');
const voiceChatBtn = document.getElementById('voiceChat');

let tempChart = null;
let lastWeather = null; // store last fetch

/* =========================
   Voice Recognition (SpeechRecognition)
   and Speech Synthesis
========================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const synth = window.speechSynthesis || null;

function speak(text){
  if(!synth) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-GB';
  u.rate = 1;
  synth.cancel();
  synth.speak(u);
}

/* Start listening for city */
micBtn.addEventListener('click', () => {
  if(!SpeechRecognition){ alert('Speech recognition not supported in this browser.'); return; }
  const r = new SpeechRecognition();
  r.lang = 'en-IN';
  r.interimResults = false;
  r.maxAlternatives = 1;
  statusEl.textContent = 'Listening... Speak now.';
  r.onresult = (ev) => {
    const text = ev.results[0][0].transcript.trim();
    cityInput.value = text;
    statusEl.textContent = `Heard: "${text}" â€” searching...`;
    fetchWeatherByCity(text);
  };
  r.onerror = (e) => { statusEl.textContent = 'Voice error: ' + (e.error||e.message); };
  r.onend = ()=> { /* nothing */ };
  r.start();
});

/* Chat voice input (press voiceChat to listen) */
voiceChatBtn.addEventListener('click', () => {
  if(!SpeechRecognition){ alert('Speech recognition not supported in this browser.'); return; }
  const r = new SpeechRecognition();
  r.lang = 'en-IN';
  r.interimResults = false;
  r.maxAlternatives = 1;
  statusEl.textContent = 'Chat listening...';
  r.onresult = (ev) => {
    const text = ev.results[0][0].transcript.trim();
    appendChat('me', text);
    handleChat(text);
  };
  r.onerror = (e) => { statusEl.textContent = 'Voice error: ' + (e.error||e.message); };
  r.start();
});

/* =========================
   Geocoding + Weather fetch
   We use:
   - Geocoding: http://api.openweathermap.org/geo/1.0/direct?q={city}&limit=1&appid=KEY
   - One Call (v3/v2) / or hourly forecast via "onecall" requires lat/lon
========================= */

async function geocodeCity(city){
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${OWM_API_KEY}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Geocode failed');
  const arr = await r.json();
  if(!arr || arr.length === 0) throw new Error('Location not found');
  return arr[0]; // {name, lat, lon, country}
}

async function fetchOneCall(lat, lon){
  // Using 'onecall' (free tier supports it), request hourly & current
  const url = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&units=metric&exclude=minutely,alerts&appid=${OWM_API_KEY}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Weather fetch failed');
  return await r.json();
}

/* Main: fetch weather by city name */
async function fetchWeatherByCity(city){
  if(!OWM_API_KEY || OWM_API_KEY === 'YOUR_API_KEY'){
    alert('Please set your OpenWeatherMap API key in the script (replace YOUR_API_KEY).');
    return;
  }
  try {
    statusEl.textContent = 'Resolving location...';
    const geo = await geocodeCity(city);
    statusEl.textContent = `Fetching weather for ${geo.name}, ${geo.country}...`;
    const data = await fetchOneCall(geo.lat, geo.lon);

    // store last weather & display
    lastWeather = { geo, data };
    renderCurrent(geo, data.current);
    renderChart(data.hourly);
    statusEl.textContent = `Last updated: ${new Date().toLocaleString()}`;
    appendChat('bot', `Weather for ${geo.name}, ${geo.country} updated. Current ${Math.round(data.current.temp)}Â°C, ${data.current.weather[0].description}.`);
    speak(`Weather for ${geo.name}. ${Math.round(data.current.temp)} degrees Celsius. ${data.current.weather[0].description}.`);
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Error: ' + (err.message || err);
    appendChat('bot', 'Sorry, could not fetch weather: ' + (err.message || 'unknown'));
    speak('Sorry, I could not fetch the weather. Check the console or your API key.');
  }
}

/* Render current weather card */
function renderCurrent(geo, current){
  currentCard.style.display = 'flex';
  placeEl.textContent = `${geo.name}, ${geo.country}`;
  descEl.textContent = current.weather[0].description;
  tempEl.textContent = `${Math.round(current.temp)}Â°C`;
  feelsEl.textContent = `Feels like ${Math.round(current.feels_like)}Â°C`;
  iconEl.src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@4x.png`;
  iconEl.alt = current.weather[0].description;

  metricsEl.innerHTML = '';
  const items = [
    ['Humidity', current.humidity + '%'],
    ['Wind', (current.wind_speed || current.wind_speed) + ' m/s'],
    ['Pressure', current.pressure + ' hPa'],
    ['UV index', (current.uvi !== undefined ? current.uvi : 'â€”')],
    ['Visibility', (current.visibility ? (current.visibility/1000).toFixed(1) + ' km' : 'â€”')]
  ];
  items.forEach(it=> {
    const dom = document.createElement('div');
    dom.className = 'metric';
    dom.innerHTML = `<strong style="display:block">${it[1]}</strong><small style="color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')};">${it[0]}</small>`;
    metricsEl.appendChild(dom);
  });
}

/* Render chart (hourly temps). We'll show next 12 hours */
function renderChart(hourly){
  const hours = hourly.slice(0, 12);
  const labels = hours.map(h => {
    const d = new Date(h.dt * 1000);
    return d.getHours() + ':00';
  });
  const temps = hours.map(h => h.temp);

  const ctx = document.getElementById('tempChart').getContext('2d');

  if(tempChart) tempChart.destroy();

  tempChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Temperature (Â°C)',
        data: temps,
        fill: true,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: false }
      }
    }
  });
}

/* =========================
   Chat boat (simple rule-based)
========================= */
function appendChat(who, text){
  const m = document.createElement('div');
  m.className = 'msg ' + (who === 'me' ? 'me' : '');
  const b = document.createElement('div');
  b.className = 'bubble ' + (who === 'me' ? 'me' : '');
  b.textContent = text;
  m.appendChild(b);
  chatWindow.appendChild(m);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

sendChat.addEventListener('click', () => {
  const txt = chatInput.value.trim();
  if(!txt) return;
  appendChat('me', txt);
  chatInput.value = '';
  handleChat(txt);
});

/* handle chat: matched intents */
function handleChat(text){
  text = text.toLowerCase();
  // basic intents
  if(text.includes('forecast for') || text.includes('for ') && /forecast|weather|temperature|temp/.test(text)){
    // extract city after 'for' or last word
    const m = text.match(/for (.+)/) || text.match(/forecast (.+)/);
    const city = m ? m[1].trim() : text;
    appendChat('bot', `Getting forecast for ${city}...`);
    fetchWeatherByCity(city);
    return;
  }
  if(/temperature|temp|how hot|how cold/.test(text)){
    if(lastWeather){
      const t = Math.round(lastWeather.data.current.temp);
      const resp = `Current temperature in ${lastWeather.geo.name} is ${t}Â°C.`;
      appendChat('bot', resp);
      speak(resp);
    } else {
      appendChat('bot', 'No weather loaded. Ask "forecast for <city>" or press Search.');
      speak('No weather loaded. Tell me a city to fetch weather for.');
    }
    return;
  }
  if(/humidity|humid/.test(text)){
    if(lastWeather){
      const h = lastWeather.data.current.humidity;
      const resp = `Humidity in ${lastWeather.geo.name} is ${h} percent.`;
      appendChat('bot', resp); speak(resp); return;
    } else { appendChat('bot','No data loaded yet.'); speak('No data loaded yet.'); return; }
  }
  if(/help|commands|what can you do/.test(text)){
    const resp = 'I can fetch weather for a city, read current temperature, humidity, or show an hourly chart. Try "forecast for Delhi" or press the mic and say a city.';
    appendChat('bot', resp); speak(resp); return;
  }

  // fallback small talk
  const fallback = "Sorry, I didn't get that. Try 'forecast for <city>' or 'temperature'.";
  appendChat('bot', fallback); speak(fallback);
}

/* Keyboard enter for city or chat */
cityInput.addEventListener('keydown', (e) => { if(e.key==='Enter') searchBtn.click(); });
chatInput.addEventListener('keydown', (e) => { if(e.key==='Enter') sendChat.click(); });

searchBtn.addEventListener('click', () => {
  const city = cityInput.value.trim();
  if(!city){ statusEl.textContent = 'Type or say a city first.'; return; }
  fetchWeatherByCity(city);
});

/* On load: hint */
document.addEventListener('DOMContentLoaded', () => {
  statusEl.textContent = 'Ready â€” type a city or click the mic to speak.';
});
</script>

</body>
</html>
